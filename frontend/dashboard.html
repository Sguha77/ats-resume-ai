<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ATS Resume AI</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>üìã Your Dashboard</h1>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </header>

    <main>
      <section class="upload-section">
        <h2>Upload New Resume</h2>
        <input type="file" id="resumeUpload" accept=".pdf,.doc,.docx,.txt">
        <button id="uploadBtn">Upload</button>
      </section>

      <!-- Upload Progress Bar -->
      <div id="uploadProgressContainer" style="
        width: 100%;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
        display: none;
        margin-top: 10px;
        position: relative;
        height: 20px;
      ">
        <div id="uploadProgressBar" style="
          height: 100%;
          width: 0%;
          background: linear-gradient(90deg, #667eea, #764ba2);
          transition: width 0.3s ease;
        "></div>
        <span id="uploadProgressText" style="
          position: absolute;
          top: 0;
          left: 50%;
          transform: translateX(-50%);
          font-size: 0.9em;
          color: #000;
          line-height: 20px;
          font-weight: 500;
          display: none;
        ">0%</span>
      </div>

      <section id="resumeListSection">
        <h2>Your Uploaded Resumes</h2>
        <div id="resumeList" class="resume-list"></div>
      </section>
    </main>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const API_URL = "http://";

    if (!token) {
      window.location.href = "login.html";
    }

    const logoutBtn = document.getElementById("logoutBtn");
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("resumeUpload");

    const progressContainer = document.getElementById("uploadProgressContainer");
    const progressBar = document.getElementById("uploadProgressBar");
    const progressText = document.getElementById("uploadProgressText");

    uploadBtn.addEventListener("click", async () => {
      const file = fileInput.files[0];
      if (!file) return alert("Please select a resume to upload!");

      const formData = new FormData();
      formData.append("resume", file);

      progressContainer.style.display = "block";
      progressText.style.display = "block";
      progressBar.style.width = "0%";
      progressText.textContent = "0%";

      try {
        const xhr = new XMLHttpRequest();
        xhr.open("POST", `${API_URL}/upload`);
        xhr.setRequestHeader("Authorization", `Bearer ${token}`);

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `${percent}%`;
          }
        };

        xhr.onload = () => {
          if (xhr.status === 200) {
            alert("‚úÖ Resume uploaded successfully!");
            loadResumes();
            setTimeout(() => {
              progressContainer.style.display = "none";
            }, 800);
          } else {
            alert("‚ùå Upload failed. Try again.");
          }
        };

        xhr.send(formData);
      } catch (error) {
        console.error("Upload Error:", error);
        alert("Error uploading file.");
      }
    });

    async function loadResumes() {
      const res = await fetch(`${API_URL}/list`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();

      const resumeList = document.getElementById("resumeList");
      resumeList.innerHTML = "";

      if (!data.length) {
        resumeList.innerHTML = "<p>No resumes uploaded yet.</p>";
        return;
      }

      data.forEach((resume) => {
        const div = document.createElement("div");
        div.classList.add("resume-card");
        div.innerHTML = `
          <h3>${resume.fileName}</h3>
          <p>Uploaded on: ${new Date(resume.createdAt).toLocaleString()}</p>
          <button onclick="getSuggestions('${resume._id}')">Get AI Suggestions</button>
        `;
        resumeList.appendChild(div);
      });
    }

    async function getSuggestions(id) {
      const res = await fetch(`${API_URL}/suggestions/${id}`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await res.json();
      alert("üí° AI Suggestions:\n\n" + data.suggestions);
    }

    loadResumes();
  </script>
</body>
</html>
